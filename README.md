# skill-trader

Claude Code plugin for automated MetaTrader 5 Expert Advisor build & backtest on macOS.

**Compile** (.mq5 -> .ex5) -> **Backtest** (real tick data) -> **Monitor** -> **Collect** (CSV with trade-by-trade analysis)

## Installation

### Method 1: Setup New EA Project (Recommended)

```bash
# Create a new EA project with full pipeline
curl -fsSL https://raw.githubusercontent.com/anhnguyen123312/skill-trader/main/setup.sh | bash -s -- my-ea-project
cd my-ea-project

# Or setup in current directory
curl -fsSL https://raw.githubusercontent.com/anhnguyen123312/skill-trader/main/setup.sh | bash
```

This creates the full project structure with scripts, config, example EA, and Claude Code skill.

### Method 2: Add to Existing Project

```bash
# Full pipeline (scripts + config + skill + example EA)
curl -fsSL https://raw.githubusercontent.com/anhnguyen123312/skill-trader/main/install.sh | bash -s -- --full

# Skill only (Claude Code integration)
curl -fsSL https://raw.githubusercontent.com/anhnguyen123312/skill-trader/main/install.sh | bash

# Skill only (global - all projects)
curl -fsSL https://raw.githubusercontent.com/anhnguyen123312/skill-trader/main/install.sh | bash -s -- --global
```

### Method 3: Clone

```bash
git clone https://github.com/anhnguyen123312/skill-trader.git my-ea-project
cd my-ea-project
```

## Prerequisites

| Requirement | Install | Notes |
|-------------|---------|-------|
| MetaTrader 5 | `brew install --cask metatrader5` or [download](https://www.metatrader5.com/en/download) | Includes Wine, MetaEditor, Terminal |
| macOS | Required | Wine bundled with MT5 app |
| iconv | Built-in | For UTF-16LE log parsing |

All dependencies (Wine64, MetaEditor64, Terminal64) come bundled with the MT5 app. No separate installation needed.

## Quick Start

```bash
# 1. Login (interactive - prompts for missing fields)
./.skill-trader/backtest/scripts/login.sh

# 2. Place your EA source
cp MyEA.mq5 code/experts/

# 3. Run backtest (interactive - prompts all params)
./.skill-trader/backtest/scripts/backtest.sh

# 4. Or run full pipeline with CLI args
./.skill-trader/backtest/scripts/run.sh MyEA XAUUSD M15 2024.01.01 2024.12.31 --no-visual

# 5. Results appear in .skill-trader/backtest/results/
```

## Skills

| Skill | Trigger | Description |
|-------|---------|-------------|
| `mt5-backtest` | "backtest EA", "compile EA", "test EA" | Full build & backtest pipeline |

## Repository Structure

```
skill-trader/
  .claude-plugin/
    plugin.json              # Plugin manifest
    marketplace.json         # Marketplace config
  skills/
    mt5-backtest/
      SKILL.md               # Skill documentation
  .skill-trader/
    backtest/
      scripts/
        run.sh               # E2E orchestrator
        compile.sh           # MQ5 -> EX5 via Wine MetaEditor
        backtest.sh          # Launch MT5 backtest (interactive or CLI)
        monitor.sh           # Poll for completion
        collect.sh           # Parse CSV results
        login.sh             # Login & credential manager (interactive)
      config/
        backtest.template.ini  # [Tester] config with __PLACEHOLDERS__
        credentials.env        # Auto-generated by login.sh (gitignored)
        mt5-credentials/       # Backup of accounts.dat, servers.dat, common.ini (gitignored)
      results/               # CSV outputs & logs
  code/
    experts/
      SimpleMA_EA.mq5        # Example EA with OnTester() export
  install.sh                 # One-liner installer
  setup.sh                   # Project setup script
```

## Usage

### Interactive Mode (Recommended)

```bash
# Login - prompts for Login, Server, Password step by step
./.skill-trader/backtest/scripts/login.sh
# Login [128364028]:          <- Enter = use default
# Server [Exness-MT5Real7]:   <- Enter = use default
# Password:                   <- hidden input, required

# Backtest - prompts for EA, Symbol, Period, Date, Visual
./.skill-trader/backtest/scripts/backtest.sh
# Available EAs:
#   1. SimpleMA_EA
# EA [1]:                     <- pick by number or name
# Symbol [XAUUSD]:
# Period [M15]:
# From [2024.01.01]:
# To [2024.12.31]:
# Visual? (y/n) [n]:
```

### CLI Mode

```bash
# E2E pipeline
./.skill-trader/backtest/scripts/run.sh <EA_NAME> [SYMBOL] [PERIOD] [FROM] [TO] [--no-visual]

# Examples
./.skill-trader/backtest/scripts/run.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.12.31 --no-visual
./.skill-trader/backtest/scripts/run.sh MyEA EURUSD H1 2023.01.01 2024.12.31 --no-visual

# Individual steps
./.skill-trader/backtest/scripts/compile.sh SimpleMA_EA
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.12.31 --no-visual
./.skill-trader/backtest/scripts/monitor.sh 30
./.skill-trader/backtest/scripts/collect.sh SimpleMA_EA XAUUSD M15

# Login management
./.skill-trader/backtest/scripts/login.sh                          # Interactive login
./.skill-trader/backtest/scripts/login.sh <LOGIN> <PASS> <SERVER>  # Direct login
./.skill-trader/backtest/scripts/login.sh --status                 # Check status
./.skill-trader/backtest/scripts/login.sh --backup                 # Backup credentials
./.skill-trader/backtest/scripts/login.sh --restore                # Restore from backup
```

## Credential Management

### How It Works

1. `login.sh` authenticates with MT5 via Wine, caches credentials in `accounts.dat`
2. After successful login, saves password to `.skill-trader/backtest/config/credentials.env` (chmod 600)
3. `backtest.sh` reads `credentials.env` and includes `Password=` in `[Common]` section
4. MT5 Tester uses the password to authenticate without showing a login popup
5. `login.sh --backup` saves `accounts.dat`, `servers.dat`, `common.ini` to `.skill-trader/backtest/config/mt5-credentials/`

### Credential Priority (highest first)

1. Environment variables: `MT5_LOGIN`, `MT5_PASSWORD`, `MT5_SERVER`
2. `.skill-trader/backtest/config/credentials.env` (auto-generated by `login.sh`)
3. Cached `common.ini` (for login/server defaults only)
4. Hardcoded defaults: `128364028` / `Exness-MT5Real7`

### Security

- `.skill-trader/backtest/config/credentials.env` is in `.gitignore` (never committed)
- `.skill-trader/backtest/config/mt5-credentials/` is in `.gitignore` (never committed)
- `credentials.env` is chmod 600 (owner-only read/write)
- Login config (contains password) is deleted after use

## Config

Template: `.skill-trader/backtest/config/backtest.template.ini` (only `[Tester]` section - `[Common]` is generated dynamically by `backtest.sh`)

| Parameter | Default | Description |
|-----------|---------|-------------|
| Deposit | 1000 | Starting capital (USD) |
| Leverage | 1:1000 | Broker leverage |
| Model | 4 | 0=Every tick, 1=1min OHLC, 2=Open prices, 4=Real ticks |
| Delay | 100 | Slippage emulation (ms) |

See `skills/mt5-backtest/SKILL.md` for full documentation, troubleshooting, and known issues.

## Test Flows

Verified test scenarios for the plugin pipeline.

### Flow 1: Fresh Install + First Login

```bash
# 1. Setup new project
curl -fsSL .../setup.sh | bash -s -- test-project && cd test-project

# 2. First login (no cached credentials)
./.skill-trader/backtest/scripts/login.sh
# Expected: prompts Login/Server/Password, authenticates, saves credentials.env
# Verify: ./.skill-trader/backtest/scripts/login.sh --status -> "READY"

# 3. Backup credentials
./.skill-trader/backtest/scripts/login.sh --backup
# Expected: accounts.dat (~8KB), servers.dat (~900KB), common.ini saved
```

### Flow 2: Backtest (Interactive)

```bash
# 1. Run backtest with prompts
./.skill-trader/backtest/scripts/backtest.sh
# Expected: lists available EAs, prompts all params, launches MT5
# Verify: NO login popup, MT5 runs backtest automatically

# 2. Monitor
./.skill-trader/backtest/scripts/monitor.sh
# Expected: "BACKTEST COMPLETE", CSV found

# 3. Collect results
./.skill-trader/backtest/scripts/collect.sh SimpleMA_EA XAUUSD M15
# Expected: CSV saved to .skill-trader/backtest/results/, summary displayed
```

### Flow 3: Backtest (CLI)

```bash
./.skill-trader/backtest/scripts/run.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.12.31 --no-visual
# Expected: compile -> backtest -> monitor -> collect, all automatic
# Verify: .skill-trader/backtest/results/<date>_SimpleMA_EA_XAUUSD_M15.csv exists
```

### Flow 4: Credential Recovery

```bash
# 1. Delete all credentials (simulate corruption)
rm -f "$MT5_CONFIG/accounts.dat" "$MT5_CONFIG/servers.dat" "$MT5_CONFIG/common.ini"
rm -f .skill-trader/backtest/config/credentials.env

# 2. Verify NOT READY
./.skill-trader/backtest/scripts/login.sh --status
# Expected: "NOT READY"

# 3. Restore from backup
./.skill-trader/backtest/scripts/login.sh --restore
# Expected: all 3 files restored

# 4. Re-login (to regenerate credentials.env)
./.skill-trader/backtest/scripts/login.sh
# Expected: prompts password, authenticates, saves credentials.env

# 5. Backtest should work
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.01.31 --no-visual
# Expected: completes without login popup
```

### Flow 5: Login Popup Bug (Regression Test)

```bash
# This flow verifies the login popup fix stays working

# 1. Delete credentials.env (simulates missing password)
rm -f .skill-trader/backtest/config/credentials.env

# 2. Run backtest
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.01.31 --no-visual

# 3. EXPECTED BUG: MT5 shows login popup (Password missing from [Common])
# FIX: re-run ./.skill-trader/backtest/scripts/login.sh to regenerate credentials.env
# THEN: backtest works without popup
```

### Flow 6: Different Timeframes

```bash
# M15 (fast, ~5-10s)
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD M15 2024.01.01 2024.01.31 --no-visual

# H1 (medium, ~10-30s)
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD H1 2024.01.01 2024.12.31 --no-visual

# D1 (fast, ~5s)
./.skill-trader/backtest/scripts/backtest.sh SimpleMA_EA XAUUSD D1 2023.01.01 2025.12.31 --no-visual
```

## License

MIT
